<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>File: {{ doc.file.name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-8">
  <div class="w-full max-w-4xl bg-white shadow-2xl rounded-3xl p-10">

    <!-- Navigation -->
    <div class="flex justify-between items-center mb-10">
      <a href="/" class="text-gray-600 hover:text-black font-medium transition">
        ‚Üê Back
      </a>
      <a href="{{ doc.file.url }}" download
         class="px-5 py-2 bg-black text-white text-sm font-medium rounded-2xl shadow hover:opacity-90 transition">
        Download File
      </a>
    </div>

    <h1 class="text-4xl font-semibold text-gray-900 tracking-tight mb-6">
      {{ file_name }}
    </h1>

    <!-- Analyze Resume Button -->
    <div class="text-center mb-8">
      <button id="analyzeBtn"
              class="px-8 py-3 bg-green-600 text-white text-lg font-semibold rounded-2xl shadow hover:bg-green-700 transition">
        üîç Analyze Resume
      </button>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="mt-4 hidden text-gray-600 flex items-center justify-center gap-3">
      <svg class="animate-spin h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10"
                stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z">
        </path>
      </svg>
      <span class="text-gray-700 text-sm font-medium">Analyzing resume, please wait...</span>
    </div>

    <!-- File Content -->
    <div class="mt-8">
      <h2 class="text-xl font-semibold text-gray-800 mb-3">Resume Content</h2>
      <div class="bg-gray-50 p-5 rounded-2xl shadow-inner max-h-[50vh] overflow-y-auto">
        <pre class="whitespace-pre-wrap break-words text-gray-800 text-sm font-mono">
{{ content }}
        </pre>
      </div>
    </div>

    <!-- Job Description -->
    <div class="mt-10">
      <h2 class="text-xl font-semibold text-gray-800 mb-3">Job Description</h2>
      <div class="bg-gray-50 p-5 rounded-2xl shadow-inner max-h-[50vh] overflow-y-auto">
        <pre class="whitespace-pre-wrap break-words text-gray-800 text-sm font-mono">
{{ doc.job_description }}
        </pre>
      </div>
    </div>

    <!-- Analysis Result -->
    <div id="analysisResult"
         class="mt-8 hidden rounded-2xl border border-emerald-200/60 bg-gradient-to-b from-emerald-50/80 to-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 shadow-xl ring-1 ring-emerald-500/10 transition-all duration-300 ease-out">
      <div class="flex items-center justify-between gap-3 border-b border-emerald-100/70 px-6 py-4">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-emerald-100 text-emerald-700 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
              <path d="M11 3a1 1 0 0 1 2 0v1.06a8.001 8.001 0 0 1 6.94 6.94H21a1 1 0 1 1 0 2h-1.06a8.001 8.001 0 0 1-6.94 6.94V21a1 1 0 1 1-2 0v-1.06A8.001 8.001 0 0 1 4.06 13H3a1 1 0 1 1 0-2h1.06A8.001 8.001 0 0 1 11 4.06V3zm1 4a6 6 0 1 0 0 12A6 6 0 0 0 12 7zm-1 2h2v4h-2V9zm0 5h2v2h-2v-2z"></path>
            </svg>
          </span>
          <h2 class="text-black font-semibold">Analysis Result</h2>
        </div>
        <span class="rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-medium text-black">
          Updated
        </span>
      </div>

      <div id="resultContent" class="prose prose-sm max-w-none px-6 py-5" style="color: black;">
      </div>
    </div>

    <!-- Footer Link -->
    <div class="mt-12 text-center">
      <a href="{% url 'all_files' %}" class="text-gray-600 hover:text-black text-lg font-medium transition">
        View Uploaded Files ‚Üí
      </a>
    </div>

  </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultDiv = document.getElementById("analysisResult");
    const resultContent = document.getElementById("resultContent");
    const loadingSpinner = document.getElementById("loadingSpinner");

    analyzeBtn.addEventListener("click", function () {
        // Show loading spinner, hide previous results
        loadingSpinner.classList.remove("hidden");
        resultDiv.classList.add("hidden");

        fetch(`/analyze/{{ doc.id }}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.classList.add("hidden");
            resultDiv.classList.remove("hidden");

            if (data.status === "success") {
                let resultHtml = `<p class="mb-2"><strong>ATS Score:</strong> ${data.result.ats_score}%</p>`;
                resultHtml += "<ul class='list-disc pl-5 space-y-1'>";
                data.result.suggestions.forEach(s => {
                    resultHtml += `<li>${s}</li>`;
                });
                resultHtml += "</ul>";
                resultContent.innerHTML = resultHtml;
            } else {
                resultContent.innerHTML = `<p class="text-red-600 font-medium">Error: ${data.message}</p>`;
            }
        })
        .catch(err => {
            loadingSpinner.classList.add("hidden");
            resultDiv.classList.remove("hidden");
            resultContent.innerHTML = `<p class="text-red-600 font-medium">Request failed: ${err}. Please check your server or CSRF token.</p>`;
        });
    });
});
</script>

</body>
</html>
